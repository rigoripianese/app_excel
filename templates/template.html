<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ nome_completo }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style_players.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/logo.webp') }}" type="image/x-icon">
    <script>
        // Check if the user is authenticated
        window.onload = function() {
            const isAuthenticated = sessionStorage.getItem('isAuthenticated');
            if (!isAuthenticated) {
                // Redirect to login page if not authenticated
                const redirectUrl = `{{ url_for('static', filename='campionato/squadre/' + nome_squadra + '/' + nome_giocatore + '/' + nome_giocatore + '.html') }}`;
                window.location.href = `{{ url_for('static', filename='login/login.html') }}?redirect=${encodeURIComponent(redirectUrl)}`;
            }
        }
    </script>
</head>
<body>
    <header>
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.webp') }}" alt="Logo Pianese">
        </div>
        <nav>
            <ul>
                <li><a href="{{ url_for('static', filename='index.html') }}">Torna alla Home</a></li>
                <li><a href="{{ url_for('static', filename='campionato/campionato.html') }}">Campionato</a></li>
                <li><a href="{{ url_for('static', filename='coppa/coppa.html') }}">Coppa</a></li>
                <li><a href="{{ url_for('static', filename='calendario/calendario.html') }}">Calendario</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <h1>{{ nome_completo }}</h1>
        <img src="{{ nome_giocatore }}.webp" style="width: 5%;">
        <div class="container">
            <h2 style="text-align: center; font-weight: bolder;">
                Piede di Calcio: {{ piede_giocatore }}
            </h2>
        </div>
        <div class="clutch-container">
            <h2>Valore Clutch</h2>
            <canvas id="clutch-chart" width="200" height="200"></canvas>
        </div>
        <div class="back_arrow">
            <p style="margin-bottom: 40px;">Clicca la freccia per tornare alla selezione dei giocatori</p>
            <a href="{{ url_for('static', filename='campionato/squadre/' + nome_squadra + '/' + nome_squadra + '.html') }}">
                <img src="{{ url_for('static', filename='images/back_arrow.png') }}" style="width: 10%;">
            </a>
        </div>
        <div class="goal">
            <img src="{{ url_for('static', filename='images/porta.png') }}" alt="Goal" width="730" height="244">
            <div id="balls-container" class="balls-container">
                {{ balls_html|safe }}
            </div>
        </div>
        <div class="list_of_penalties">
                {{ list_html|safe }}
        </div>
        <div class="grafici">
            {{ grafici_html|safe }}
        </div>
    </main>
    <footer>
        <p>&copy; Fabio Rossi e Umberto Di Giacomo</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script>
        const clutchValue = {{ clutch_value }};
        const clutchColor = clutchValue < 40 ? 'red' : (clutchValue < 70 ? 'yellow' : 'green');

        const ctx = document.getElementById('clutch-chart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [clutchValue, 100 - clutchValue],
                    backgroundColor: [clutchColor, '#e0e0e0'],
                    borderWidth: 1,
                }]
            },
            options: {
                plugins: {
                    tooltip: { enabled: false },
                    legend: { display: false },
                    datalabels: {
                        display: false, // Disabilitiamo le etichette standard
                    }
                },
                cutout: '80%', // Rende il grafico a ciambella
                responsive: true,
                maintainAspectRatio: true,
            },
            plugins: [{
                // Plugin personalizzato per aggiungere il valore al centro del grafico
                id: 'clutchLabel',
                beforeDraw: (chart) => {
                    const { width } = chart;
                    const { height } = chart;
                    const ctx = chart.ctx;
                    ctx.restore();
                    const fontSize = (height / 100).toFixed(2); // Dimensione dinamica in base al grafico
                    ctx.font = `${fontSize}em Arial`;
                    ctx.textBaseline = 'middle';

                    const text = `${clutchValue.toFixed(1)}%`;
                    const textX = Math.round((width - ctx.measureText(text).width) / 2);
                    const textY = height / 2;

                    ctx.fillStyle = clutchColor;
                    ctx.fillText(text, textX, textY);
                    ctx.save();
                }
            }]
        });
    </script>
</body>
</html>